---
- name: Deploy Nginx with HTTPS
  hosts: webservers
  become: yes
  tasks:
    - name: Install Nginx
      apt:
        name: nginx
        state: present
        update_cache: yes

    - name: Create Web Root
      file:
        path: /var/www/lab-site
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Deploy index.html
      copy:
        dest: /var/www/lab-site/index.html
        content: |
          <!DOCTYPE html>
          <html>
          <head><title>Lab Server</title></head>
          <body>
              <h1>ðŸ”’ SOC Lab Server</h1>
              <p>Deployed via Ansible. Nginx + HTTPS configured successfully.</p>
          </body>
          </html>

    - name: Create SSL directory
      file:
        path: /etc/nginx/ssl
        state: directory
        owner: root
        group: root
        mode: '0700'

    - name: Generate self-signed SSL certificate
      command: >
        openssl req -x509 -nodes -days 365 -newkey rsa:2048
        -keyout /etc/nginx/ssl/lab-server.key
        -out /etc/nginx/ssl/lab-server.crt
        -subj "/C=IN/ST=Maharashtra/L=Mumbai/O=SOCLab/CN=lab-server.local"
      args:
        creates: /etc/nginx/ssl/lab-server.crt

    - name: Set SSL key permissions
      file:
        path: /etc/nginx/ssl/lab-server.key
        mode: '0600'

    - name: Copy Nginx Config
      copy:
        src: ../configs/nginx.conf
        dest: /etc/nginx/sites-available/lab-site
      notify: Reload Nginx

    - name: Enable Site (symlink)
      file:
        src: /etc/nginx/sites-available/lab-site
        dest: /etc/nginx/sites-enabled/lab-site
        state: link
      notify: Reload Nginx

    - name: Remove default site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload Nginx

    - name: Ensure Nginx is running
      service:
        name: nginx
        state: started
        enabled: yes

  handlers:
    - name: Reload Nginx
      service:
        name: nginx
        state: reloaded
